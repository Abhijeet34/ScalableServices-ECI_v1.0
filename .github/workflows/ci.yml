name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and start services
      env:
        DOCKER_BUILDKIT: 1
        COMPOSE_DOCKER_CLI_BUILD: 1
      run: |
        docker compose version
        # Build and start only what is required for health check
        docker compose up -d --build postgres redis gateway

    - name: Wait for gateway health
      run: |
        set -e
        for i in {1..90}; do
          if curl -fsS http://localhost:8080/health >/dev/null; then
            echo "Gateway is healthy"; exit 0; fi
          sleep 5
        done
        echo "Gateway failed to become healthy" >&2
        docker compose logs gateway || true
        exit 1

    - name: Tear down
      if: always()
      run: |
        docker compose down -v

  lint:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install linters
      run: |
        python -m pip install --upgrade pip
        pip install ruff==0.6.8 black==24.10.0

    - name: Run linting
      run: |
        ruff check .
        # Auto-format with Black to avoid CI failures on style-only diffs
        black . -q
